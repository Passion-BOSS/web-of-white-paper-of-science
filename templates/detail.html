<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ question.title }} - 科创白皮书</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"></head>
<body>
    <!-- 头部 -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <a href="{{ url_for('index') }}">
                    <div class="logo-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="logo-text">
                        <h1>科创白皮书</h1>
                        <p>大连理工大学创新创业竞赛指南</p>
                    </div>
                </a>
            </div>

            <ul class="nav-links">
                <li><a href="{{ url_for('index') }}">首页</a></li>
                <li><a href="{{ url_for('categories') }}">问题分类</a></li>
                <li><a href="{{ url_for('ask') }}">我要提问</a></li>
                {% if current_user.is_authenticated and current_user.is_admin %}
                <li><a href="{{ url_for('admin') }}">管理面板</a></li>
                {% endif %}
            </ul>

            <div class="auth-buttons">
                {% if current_user.is_authenticated %}
                    <span class="user-welcome">欢迎, {{ current_user.username }}</span>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i>退出
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline">
                        <i class="fas fa-sign-in-alt"></i>登录
                    </a>
                    <a href="{{ url_for('register') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i>注册
                    </a>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- 消息提示 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages container">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                        <button class="flash-close" onclick="this.parentElement.style.display='none'">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- 主内容区 -->
    <div class="container main-content">
        <div class="question-detail">
            <!-- 问题标题 -->
            <div class="question-title-section">
                <div class="question-meta">
                    <span class="question-category">{{ question.category_ref.name if question.category_ref else '未知分类' }}</span>
                    <span class="question-views">
                        <i class="far fa-eye"></i> {{ question.views }}次浏览
                    </span>
                    <span class="question-date">
                        <i class="far fa-calendar"></i> {{ question.updated_at.strftime('%Y-%m-%d') }}
                    </span>
                </div>
                <h1>{{ question.title }}</h1>
            </div>

            <!-- 问题内容 -->
            <div class="question-content">
                <div class="content-section">
                    <h3><i class="fas fa-question-circle"></i> 问题描述</h3>
                    <p>{{ question.content }}</p>
                </div>

                <div class="content-section">
                    <h3><i class="fas fa-lightbulb"></i> 详细解答</h3>
                    <div class="answer-content">
                        {{ question.answer|safe }}
                    </div>
                </div>
<!-- 在问题内容后添加 -->
{% if current_user.is_authenticated and current_user.is_admin %}
<div class="admin-actions" style="margin-top: 2rem; padding: 1rem; background-color: #f8f9fa; border-radius: 5px;">
    <h4><i class="fas fa-cogs"></i> 管理员操作</h4>
    <div class="btn-group">
        <a href="{{ url_for('admin') }}"
           onclick="openEditModal({{ question.id }}); return false;"
           class="btn btn-warning">
            <i class="fas fa-edit"></i> 编辑回答
        </a>
        <button class="btn btn-danger" onclick="confirmDelete({{ question.id }})">
            <i class="fas fa-trash"></i> 删除问题
        </button>
        <button class="btn btn-info" onclick="toggleFeatured({{ question.id }})">
            <i class="fas fa-star"></i>
            {% if question.is_featured %}取消推荐{% else %}设为推荐{% endif %}
        </button>
    </div>
</div>

<script>
// 切换推荐状态
function toggleFeatured(questionId) {
    if (!confirm('确定要切换推荐状态吗？')) {
        return;
    }

    fetch(`/api/admin/toggle_featured/${questionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // 刷新页面以更新按钮文本
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            alert('操作失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('操作失败:', error);
        alert('操作过程中发生错误: ' + error.message);
    });
}

// 打开编辑模态框
function openEditModal(questionId) {
    // 先跳转到管理员页面
    window.location.href = "{{ url_for('admin') }}";

    // 保存questionId到本地存储，等管理员页面加载后使用
    localStorage.setItem('editQuestionId', questionId);
}

// 删除确认
function confirmDelete(questionId) {
    if (confirm('确定要删除这个问题吗？此操作不可撤销。')) {
        fetch(`/api/admin/delete_question/${questionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('删除成功！');
                window.location.href = "{{ url_for('index') }}";
            } else {
                alert('删除失败: ' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            console.error('删除失败:', error);
            alert('删除过程中发生错误: ' + error.message);
        });
    }
}
</script>
{% endif %}
          <!-- 下面是相关问题部分，应该保留 -->
{% if related_questions %}
<div class="content-section">
    <h3><i class="fas fa-link"></i> 相关问题</h3>
    <div class="related-questions">
        {% for related in related_questions %}
        <a href="{{ url_for('detail', question_id=related.id) }}" class="related-question">
            <h5>{{ related.title }}</h5>
            <p>{{ related.answer|striptags|truncate(80) }}</p>
            <span class="related-meta">{{ related.views }}次浏览</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}
            </div>

            <!-- 操作按钮 -->
            <div class="question-actions">
                <a href="{{ url_for('categories') }}?category={{ question.category_ref.slug if question.category_ref else '' }}" class="btn btn-secondary">
                    <i class="fas fa-list"></i> 返回分类
                </a>
                <a href="{{ url_for('ask') }}" class="btn btn-primary">
                    <i class="fas fa-question-circle"></i> 我有类似问题
                </a>
            </div>
        </div>
    </div>

    <!-- 底部 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h5>科创白皮书</h5>
                    <p>大连理工大学创新创业竞赛一站式指南，整合高频问题与解决方案，助力学生科创之路。</p>
                </div>

                <div class="footer-section">
                    <h5>快速链接</h5>
                    <ul class="footer-links">
                        <li><a href="{{ url_for('index') }}">首页</a></li>
                        <li><a href="{{ url_for('categories') }}">问题分类</a></li>
                        <li><a href="{{ url_for('ask') }}">我要提问</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h5>主要比赛</h5>
                    <ul class="footer-links">
                        <li><a href="#">大学生创新创业训练计划</a></li>
                        <li><a href="#">"挑战杯"全国大学生系列竞赛</a></li>
                        <li><a href="#">"互联网+"大学生创新创业大赛</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h5>联系我们</h5>
                    <ul class="footer-links">
                        <li><a href="#">大连理工大学创新创业学院</a></li>
                        <li><a href="#">科创白皮书-学姐学长邮箱: kcb@dlut.edu.cn</a></li>
                        <li><a href="#">微信公众号: DUT科创白皮书</a></li>
                    </ul>
                </div>
            </div>

            <div class="copyright">
                <p>&copy; 2026 大连理工大学科创白皮书 | 设计：大工书院6人小组 | 仅供内部使用</p>
            </div>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>